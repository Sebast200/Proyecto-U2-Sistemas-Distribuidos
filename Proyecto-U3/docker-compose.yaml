version: '3.8'

services:
  # --- NODO A ---
  pg-a:
    image: postgres:15-alpine
    container_name: pg-a
    hostname: pg-a
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: adminpassword
      POSTGRES_DB: hospital_db
    # Comando vital: Si existe archivo 'standby', arranca como esclavo. Si no, como maestro.
    command: >
      bash -c "
      if [ -f /var/lib/postgresql/data/standby.signal ]; then
        docker-entrypoint.sh postgres;
      else
        docker-entrypoint.sh postgres -c wal_level=replica -c hot_standby=on -c max_wal_senders=10 -c max_replication_slots=10 -c hot_standby_feedback=on;
      fi"
    volumes:
      - pg_a_data:/var/lib/postgresql/data
    networks:
      - hospital-net

  # --- NODO B ---
  pg-b:
    image: postgres:15-alpine
    container_name: pg-b
    hostname: pg-b
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: adminpassword
      POSTGRES_DB: hospital_db
    command: >
      bash -c "
      if [ -f /var/lib/postgresql/data/standby.signal ]; then
        docker-entrypoint.sh postgres;
      else
        docker-entrypoint.sh postgres -c wal_level=replica -c hot_standby=on -c max_wal_senders=10 -c max_replication_slots=10 -c hot_standby_feedback=on;
      fi"
    volumes:
      - pg_b_data:/var/lib/postgresql/data
    networks:
      - hospital-net

  # --- ORQUESTADOR ---
  haproxy:
    image: haproxy:2.7
    container_name: haproxy
    ports:
      - "5000:5000" # Puerto ÃšNICO para la App Java
    volumes:
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    networks:
      - hospital-net

  # --- VIGILANTE SUPREMO ---
  vigilante:
    image: docker:cli
    container_name: vigilante
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock # Controlar Docker
      - ./vigilante.sh:/vigilante.sh             # El Script
      - ./:/workdir                                # Acceso a la carpeta de Windows
    working_dir: /workdir
    command: ["sh", "/vigilante.sh"]
    networks:
      - hospital-net

networks:
  hospital-net:
    driver: bridge

volumes:
  pg_a_data:
  pg_b_data:
